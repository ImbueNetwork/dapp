version: '3.8'
services:
  dynamodb-local:
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    image: "amazon/dynamodb-local:latest"
    container_name: dynamodb-local
    ports:
    - "8000:8000"
    volumes:
    - "./docker/dynamodb:/home/dynamodblocal/data"
    working_dir: /home/dynamodblocal

  api:
    build: ./api
    container_name: api
    ports:
    - "3000:3000"
    environment:
      # Even though these aren't legitimate credentials, they need to exist
      # in order for the dynamodb client to do requests.
      AWS_ACCESS_KEY_ID: foo
      AWS_SECRET_ACCESS_KEY: foo
      DYNAMODB_ENDPOINT: "http://dynamodb-local:8000"
      REGION: us-east-1

  web:
    build: ./web
    container_name: web
    ports:
    - "8080:80"
    environment:
    - API_LOCAL=http://api:3000

  imbue:
    container_name: imbue
    command: >
      /bin/bash -c "
        cd /var/log/polkadot-launch-imbue;
        polkadot-launch /polkadot-launch/polkadotLaunchConfig.js;
      "
    image: imbue-collator:latest
    ports:
    # prometheus
    - "9610:9610"
    # WS and RPC
    - "9900-9999:9900-9999"
    # P2P
    - "30000-31000:30000-31000"
    environment:
    - RELAYCHAIN_EXECUTABLE=/polkadot
    - IMBUE_COLLATOR_EXECUTABLE=/imbue-collator
    - POLKADOT_LAUNCH_BASE_PATH_BASE=/var/log/polkadot-launch-imbue
    volumes:
    # Allows you to see/control the lifespan of the logs polkadot-launch
    # creates.
    - "/tmp/polkadot-launch-imbue:/var/log/polkadot-launch-imbue"
    # Allows you to provide your own launchConfig via `command` above.
    - "./config:/polkadot-launch"
